<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OSM with Leaflet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
</head>
<body>
<div id="map" style="height: 400px;"></div>
<button onclick="clearMarker()">Clear Marker</button>
<button onclick="sendData()">Send Data to Backend</button>

<div id="coordinates-box">Coordinates: </div>
<form id="imageUploadForm">
    <label for="image">Select Image:</label>
    <input type="file" id="image" name="image" accept="image/*">
    <br>
    <button type="button" onclick="uploadImage()">Upload Image</button>
</form>
<div id="imageContainer"></div>
<button type="button" onclick="getImageById(3)">Get Image by ID 3</button>

<script>
    var map = L.map('map').setView([28.3949, 84.1240], 13);
    var marker;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var geocoder = L.Control.Geocoder.nominatim();
    var control = L.Control.geocoder({
        geocoder: geocoder,
        defaultMarkGeocode: false
    }).on('markgeocode', function (e) {
        var bbox = e.geocode.bbox;
        var poly = L.polygon([
            bbox.getSouthEast(),
            bbox.getNorthEast(),
            bbox.getNorthWest(),
            bbox.getSouthWest()
        ]).addTo(map);
        map.fitBounds(poly.getBounds());
    }).addTo(map);

    map.on('click', function (e) {
        var coordinates = e.latlng;
        updateMarker(coordinates);
    });

    function updateMarker(coordinates) {
        if (marker) {
            map.removeLayer(marker);
        }

        marker = L.marker(coordinates).addTo(map);
        marker.bindPopup("Marker at " + coordinates.lat.toFixed(4) + "° N, " + coordinates.lng.toFixed(4) + "° E");

        document.getElementById('coordinates-box').textContent = "Coordinates: " + coordinates.lat.toFixed(4) + "° N, " + coordinates.lng.toFixed(4) + "° E";
    }
function sendData() {
            if (marker) {
                var latitude = marker.getLatLng().lat.toFixed(4);
                var longitude = marker.getLatLng().lng.toFixed(4);

                var dataToSend = {
                    latitude: latitude,
                    longitude: longitude
                };

                fetch('http://localhost:8080/coordinates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend),
                })
                .then(response => console.log(response))
                .then(data => {
                    console.log('Response from backend:', data);

                })
                .catch(error => {
                    console.log('Error:', error);
                });
            } else {
                console.log('No marker to send data.');
            }
        }
    function clearMarker() {
        if (marker) {
            map.removeLayer(marker);
            marker = null;

            document.getElementById('coordinates-box').textContent = "Coordinates: ";
        }


    }
        function uploadImage() {
            const inputElement = document.getElementById('image');
            const file = inputElement.files[0];

            // Check if a file is selected
            if (file) {
                const reader = new FileReader();
                reader.onloadend = function () {
                    const base64Content = reader.result.split(',')[1];

                    const imageData = {
                        image: base64Content
                    };
                    fetch('http://localhost:8080/properties', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(imageData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Response from backend:', data);
                        // Handle the response as needed
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Handle errors
                    });
                };

                reader.readAsDataURL(file);
            } else {
                // Handle the case where no file is selected
                console.error('No file selected');
            }
        }

        function getImageById(id) {
            fetch(`http://localhost:8080/properties/${id}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const base64Content = data.image;

                displayImage(base64Content);
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle errors
            });
        }

        function displayImage(base64Content) {
            const imageElement = document.createElement('img');
            imageElement.src = `data:image.png;base64,${base64Content}`;

            // Set any additional attributes or styles as needed
            // imageElement.setAttribute('width', '300');
            // imageElement.setAttribute('height', '200');

            const imageContainer = document.getElementById('imageContainer');
            imageContainer.innerHTML = '';
            imageContainer.appendChild(imageElement);
        }

</script>


</body>
</html>